/***************************************************************************************************
 *   Project:       
 *   Author:        
 ***************************************************************************************************
 *   Distribution:  
 *
 ***************************************************************************************************
 *   MCU Family:    STM32F
 *   Compiler:      ARMCC
 ***************************************************************************************************
 *   File:          spi.c
 *   Description:   
 *
 ***************************************************************************************************
 *   History:       01.12.2019 - file created
 *
 **************************************************************************************************/

/***************************************************************************************************
 *                                      INCLUDED FILES
 **************************************************************************************************/

#include <stdlib.h>
#include <stdio.h>

#include "Driver_SPI.h"

#include "pin_config.h"

/***************************************************************************************************
 *                                       DEFINITIONS
 **************************************************************************************************/

#ifdef PIN_SPI_CS0
#define PIN_CS_ONBOARD   PIN_SPI_CS0
#endif
#define PIN_CS_MICROSD_0 PIN_SPI_CS1
#define PIN_CS_MICROSD_1 PIN_SPI_CS2

/***************************************************************************************************
 *                                      PRIVATE TYPES
 **************************************************************************************************/

/***************************************************************************************************
 *                               PRIVATE FUNCTION PROTOTYPES
 **************************************************************************************************/

/***************************************************************************************************
 *                                       PRIVATE DATA
 **************************************************************************************************/

/***************************************************************************************************
 *                                       PUBLIC DATA
 **************************************************************************************************/

/***************************************************************************************************
 *                                      EXTERNAL DATA
 **************************************************************************************************/

/***************************************************************************************************
 *                              EXTERNAL FUNCTION PROTOTYPES
 **************************************************************************************************/

/***************************************************************************************************
 *                                    PRIVATE FUNCTIONS
 **************************************************************************************************/

/***************************************************************************************************
 *                                    PUBLIC FUNCTIONS
 **************************************************************************************************/

//-- see. SPI_MultiSlave.h
void SPI_Control_SlaveSelect(uint32_t device, uint32_t ss_state)
{
    static bool pins_is_initialized = false;
    
    if (!pins_is_initialized)
    {
        gpio_out_pp_config(PIN_CS_MICROSD_0);
        gpio_write(PIN_CS_MICROSD_0, true);
        gpio_write(PIN_CS_MICROSD_1, true);
        gpio_out_pp_config(PIN_CS_MICROSD_1);
#ifdef PIN_CS_ONBOARD
        gpio_out_pp_config(PIN_CS_ONBOARD  );
        gpio_write(PIN_CS_ONBOARD  , true);
#endif
    }
    
    switch(device)
    {
        case 0:
            gpio_write(PIN_CS_MICROSD_0, (ss_state == ARM_SPI_SS_INACTIVE)); break;
        case 1:
            gpio_write(PIN_CS_MICROSD_1, (ss_state == ARM_SPI_SS_INACTIVE)); break;
#ifdef PIN_CS_ONBOARD
        case 2:
            gpio_write(PIN_CS_ONBOARD  , (ss_state == ARM_SPI_SS_INACTIVE)); break;
#endif
        default:
            printf("<spi> access error. Device %d not found.", device);
            break;
    }
}

/***************************************************************************************************
 *                                       END OF FILE
 **************************************************************************************************/
